# [数据库压力降低90%，携程机票订单缓存系统实践](https://mp.weixin.qq.com/s/aQLX5w9EpgeDvJrhIlOFxw)

## 缓存方案

### 主动式缓存

主动式缓存就是提前将可能访问到的数据加载到缓存中，然后设置过期时间，周期性刷新。等到需要查询数据的时候，可以优先命中缓存。

这种方式比较适合于数据量不大，变化不频繁的场景。

### 被动式缓存

被动式缓存是指每次查询时先从缓存中查询数据，没有则查询底层数据库，然后把数据库的查询结果加载到缓存，并设置一定的过期时间。数据过期后，当再次遇到查询请求时重复前面所说的过程。

被动式缓存具有延迟加载的特性，也就是只有真正被访问过的数据才会被加载到缓存中，能够更有效的利用缓存数据。

>机票订单的数据热度具有阶段性，用户订单成交的前后阶段订单查询频率较高，用户的历史订单查询频率就很低了。因此我们采用被动式加载的方案，随着时间的推移，老的历史订单数据会自动逐渐过期，新的订单数据被逐渐加载。缓存数据的总量保持平稳，同时避免了老旧数据的清理。

### 分布式缓存架构的数据一致性

1. 一种方案是尽量设置较短的过期时间，以使缓存数据尽快与数据源同步。但是较短的过期时间带来的是缓存命中率的大大降低，削弱了缓存数据的效果。
2. 我们设计了两套方案来更新缓存数据，保证缓存数据的实时性。两套方案相互补充，避免其一短暂失效而产生一致性问题。
    1. 扫描数据库的数据变化记录，比如数据表里面的数据更新时间戳，或者订阅数据库的binlog记录。当扫描到数据变化时，删除对应的缓存数据。
    2. 借助于携程的消息通知平台服务。在订单处理流转的各个重要环节，会有消息事件产生。通过订阅这些消息，能够感知到订单数据的变化，并且通过对不同消息的影响数据范围可以精准地配置缓存数据更新。
    两套方案的并行实施，保证了缓存数据的延迟控制在了100毫秒以内。

>这边没讲到“先删除缓存，再更新数据库”的操作，在引用2《缓存一致性问题怎么解决》里有详细的介绍。

### 缓存穿透

缓存穿透是指，在数据存储系统中不存在的记录，不会被存储到缓存中。这种记录每次的查询流量都会穿透到数据存储层。在高流量的场景下，不断查询空结果会大量消耗数据查询服务的资源，甚至在恶意流量攻击下可能拖垮数据库系统。

以机票订单为例，有些订单购买了保险，也有的订单没有购买保险的记录。没有保险产品的订单每次查询时都会从数据库中查到空的结果，命中不了缓存，消耗了大量的Batch Request。

针对这种情况，我们采取了设置空标记的措施，针对查询正常返回但是记录为空的数据，将特定的空标记写入缓存，避免了这部分流量穿透到数据库。

### 缓存击穿

缓存击穿是指，对于一个热点KEY，在其失效的瞬时，如果有大量的对这个KEY的请求，都会到达数据库。

我们通过分布式锁的方式，在缓存数据失效的时刻，仅允许单一请求读取数据库数据并加载到缓存。

### 缓存雪崩

缓存雪崩是指，在同一时间有大量缓存一起失效。

我们使用了一个简单有效的方法，对不同的缓存数据设置过期时间时，采用不同的时间，比如增加一个小的随机值。

此外，由于不同订单处理过程中的消息发生时间不同，而订单处理过程一般会有等待队列，处理时间会有差异，也降低了缓存同时失效的风险。

## 缓存优化

### 全天候分段缓存过期策略（按时间）

根据对机票订单系统每日实时订单量数据的分析，实时订单量呈现双驼峰的形态。

在订单量的峰值时段，数据库访问压力比较大，反之低谷时段则压力较小。对此我们为订单查询服务的一级缓存设置了分时段的过期时间策略，业务高峰时间段缓存时间相对调整变长，低峰时段调整变短。

每个查询服务可以单独配置这套规则，随时动态调整。这样对于数据存储端压力来说也就是起到了削峰填谷的作用。

### 订单状态分类策略（按业务）

机票订单根据业务定义有各种不同的状态，表示着订单处理流转的各个阶段。

基于对订单状态及其后续变更行为数据的分析，对于已退票或取消的终态订单，其订单数据基本不会再发生变化。这类订单的缓存过期时间可以设置的相对较长。

对于已过起飞时间的订单，用户再查看访问订单数据的概率也大大降低，其订单数据缓存时间也可以相对长一些。

而订单处理中未出票等过程态订单，短时间状态变更的可能性很高，因此不应该放入缓存之中。

### 全用户行为的订单访问预测（预加载）

根据统计，用户乘机前的几个小时内，出于关注出发时间、机场航站楼、航班变动，办理登机手续等需要，会频繁查看订单数据。数据访问的压力集中在了白天的峰值时间段内。

基于这种对用户行为的预测，我们考虑了在前一天的凌晨业务低峰阶段，将第二天业务高峰时间段内起飞的订单数据，提前加载到缓存中预热，将高峰时间段的一部分缓存构建压力，转移到了低峰时间段，既提高了低峰时间段的系统资源利用，也缓解了高峰时间段数据库的压力。不仅如此，更大的好处是，第二天订单数据库即使有短暂的故障，用户查询当天出行订单也不会受到影响，因为数据都已经提前构建在缓存里了。

## 引用
>1. [数据库压力降低90%，携程机票订单缓存系统实践](https://mp.weixin.qq.com/s/aQLX5w9EpgeDvJrhIlOFxw)
>2. [缓存一致性问题怎么解决](https://mp.weixin.qq.com/s/aJ33A5O2PUcUOA34kL-Nzw)
>3. 