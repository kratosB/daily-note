# 秒杀

1. 引用1的思路是，活动前把库存载入到redis，先用redis的decrement操作（原子性）判断是否有库存，有的话，再走下面的业务，然后去数据库扣库存。
   >这里面还可以引入mq的死信队列，如果用户超时没有支付，或者啥的，redis中的库存再加回去。
2. 引用2就是介绍了乐观锁为什么不适合秒杀，因为version改变太频繁，数据库一直更新，可能会被打爆。
3. 引用3
   1. 下单减库存：1. 有些人下单没付钱，这笔订单废了没卖出去。2. 可能会被对手攻击。（下假单不付钱）
   2. 付款减库存：1. 可能会造成“下单成功，没法付钱”的情况，体验不好（但是我感觉jd抢显卡啥的就是这样的）。
   3. 预扣库存：1. 比方法1好一点，但是不能从根本上杜绝，还是会被攻击。
   4. 秒杀减库存的极致优化：1. 可以的话直接用缓存。2. 也可以单独搞一个热点商品库。3. 应用层排队（就是类似mq啥的）。4. 数据层排队（阿里开发了xxxxx，这个就忽略了，不考虑了）。
4. 引用4
   1. 使用分布式锁来处理库存超卖问题，有一个缺陷，就是同一个商品多用户同时下单的时候，会基于分布式锁串行化处理，导致没法同时处理同一个商品的大量下单的请求。
   2. 核心思路，就是分而治之，类似concurrentHashMap的分段加锁。简单说，就是把1个库存，拆分成n个库存，这样就可以同时有n个线程获得锁。
   3. 有一个坑：如果某个下单请求，咔嚓加锁，然后发现这个分段库存里的库存不足了，此时咋办。解决：这时你得自动释放锁，然后立马换下一个分段库存，再次尝试加锁后尝试处理。这个过程一定要实现。
   4. 还有一个问题，实现太复杂了。1. 你得对一个数据分段存储，一个库存字段本来好好的，现在要分为20个分段库存字段。2. 你在每次处理库存的时候，还得自己写随机算法，随机挑选一个分段来处理。3. 如果某个分段中的数据不足了，你还得自动切换到下一个分段数据去处理。
5. 引用5：详细介绍了整个秒杀，不只是扣库存
   1. 
   2. 
   3. 
   4. 
   5. 
   6. 

## 引用
>1. [Spring Boot + redis解决商品秒杀库存超卖，看这篇文章就够了](https://mp.weixin.qq.com/s/dZxPI6V-F_Lu6V2mxNfQ2Q)
>2. [秒杀系统中乐观锁(Optimistic Lock)和悲观锁(Pessimistic Lock)的对比](https://blog.csdn.net/roufoo/article/details/108701517)
>3. [秒杀系统“减库存”设计的核心逻辑](https://mp.weixin.qq.com/s/CanwLod3te8BAPEfNXUjvw)
>4. [淘宝一面：每秒上千订单场景下，如何防止库存超卖？如何优化分布式锁？网友：真难~](https://mp.weixin.qq.com/s/6D8wRyQmx5NY-VjsRbCGMA)
>5. [从0到1设计一个秒杀系统](https://mp.weixin.qq.com/s/e4KEMkEN90rtA82hDi2D8w)
>5. [一个秒杀系统的设计思考](https://segmentfault.com/a/1190000020970562)